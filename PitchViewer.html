<html>
<head>
    <style>
        body {
            margin: 0;
        }

        /* pulsing halo used to highlight a portal */
        .pulse-halo {
            animation: pulse-halo 1s ease-out infinite;
            z-index: 99999 !important;
            /* small extra visual hint */
            box-shadow: 0 0 0 8px rgba(30,144,255,0.15);
            border-radius: 12px;
        }

        @keyframes pulse-halo {
            0% {
                box-shadow: 0 0 0 0 rgba(30,144,255,0.9), 0 0 0 0 rgba(30,144,255,0.2);
            }

            70% {
                box-shadow: 0 0 0 36px rgba(30,144,255,0), 0 0 0 12px rgba(30,144,255,0.12);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(30,144,255,0), 0 0 0 0 rgba(30,144,255,0);
            }
        }

        /* pulsing halo used to highlight a portal */
        .pulse-halo-red {
            animation: pulse-halo-red 1s ease-out infinite;
            z-index: 99999 !important;
            /* small extra visual hint */
            box-shadow: 0 0 0 8px rgba(235,64,52,0.15);
            border-radius: 12px;
        }

        @keyframes pulse-halo-red {
            0% {
                box-shadow: 0 0 0 0 rgba(235,64,52,0.9), 0 0 0 0 rgba(235,64,52,0.2);
            }

            70% {
                box-shadow: 0 0 0 36px rgba(235,64,52,0), 0 0 0 12px rgba(235,64,52,0.12);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(235,64,52,0), 0 0 0 0 rgba(235,64,52,0);
            }
        }

        /* pulsing halo used to highlight a chest */
        .pulse-halo-yellow {
            animation: pulse-halo-yellow 1s ease-out infinite;
            z-index: 99999 !important;
            /* small extra visual hint */
            box-shadow: 0 0 0 8px rgba(245,239,66,0.15);
            border-radius: 12px;
        }

        @keyframes pulse-halo-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(245,239,66,0.9), 0 0 0 0 rgba(245,239,66,0.2);
            }

            70% {
                box-shadow: 0 0 0 36px rgba(245,239,66,0), 0 0 0 12px rgba(245,239,66,0.12);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(245,239,66,0), 0 0 0 0 rgba(245,239,66,0);
            }
        }
    </style>
</head>
<body>
    <img id="selectedpitch" src="" style="max-width:100%; max-height:100%;" />
    <script>
        var mapData = null;

        const images = [
            "Pitches/Symmetric-Large-1.png"
        ];
        let currentIndex = 0;
        function showImage(index) {
            // Update the image source to show the selected image
            document.getElementById('selectedpitch').src = images[index];
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowRight') {
                currentIndex = (currentIndex + 1) % images.length;
                showImage(currentIndex);
            } else if (event.key === 'ArrowLeft') {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
                showImage(currentIndex);
            }
            // If the user presses the f key, toggle fullscreen
            else if (event.key === 'f') {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }
            // If the user presses the g key get the list of portals and chests from the text chunks stored in the image that is being shown
            else if (event.key === 'g') {
                fetch(images[currentIndex])
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onload = function () {
                            const textChunks = [];
                            const data = reader.result;
                            // Find the mapJSON text chunk in the PNG data
                            let offset = 8; // Skip PNG signature
                            while (offset < data.byteLength) {
                                const length = new DataView(data, offset, 4).getUint32(0);
                                const type = String.fromCharCode(
                                    new DataView(data, offset + 4, 1).getUint8(0),
                                    new DataView(data, offset + 5, 1).getUint8(0),
                                    new DataView(data, offset + 6, 1).getUint8(0),
                                    new DataView(data, offset + 7, 1).getUint8(0)
                                );
                                if (type === 'tEXt') {
                                    const textData = new Uint8Array(data, offset + 8, length);
                                    const textString = new TextDecoder().decode(textData);
                                    textChunks.push(textString);
                                }
                                offset += 12 + length; // Move to the next chunk
                            }
                            // Find the chunk that starts with "mapJSON"
                            const mapJSONChunk = textChunks.find(chunk => chunk.startsWith('mapJSON'));
                            if (mapJSONChunk) {
                                const jsonString = mapJSONChunk.substring(8); // Remove "mapJSON" prefix and following null character
                                mapData = JSON.parse(jsonString);
                                // For each portal in mapData, create a div with the pulse-halo-red class and position it over the portal
                                const img = document.getElementById('selectedpitch');
                                // Loop through each portal in mapData.portals
                                Array.from(mapData.portals).forEach(portal => {
                                    const halo = document.createElement('div');
                                    halo.style.position = 'absolute';
                                    halo.style.borderRadius = '50%';
                                    halo.style.width = '50px';
                                    halo.style.height = '50px';
                                    // Get the portal offsetX and offsetY and scale them to the image size compared to the width of the image at its natural size
                                    var scale = img.width / img.naturalWidth;
                                    halo.style.left = ((portal.offsetX * scale)) + 'px';
                                    halo.style.top = ((portal.offsetY * scale)) + 'px';
                                    halo.classList.add('pulse-halo-red');
                                    document.body.appendChild(halo);
                                });
                                // For each chest in mapData, create a div with the pulse-halo-red class and position it over the chest
                                // Loop through each chest in mapData.chests
                                Array.from(mapData.chests).forEach(chest => {
                                    const halo = document.createElement('div');
                                    halo.style.position = 'absolute';
                                    halo.style.borderRadius = '50%';
                                    halo.style.width = '50px';
                                    halo.style.height = '50px';
                                    // Get the chest offsetX and offsetY and scale them to the image size compared to the width of the image at its natural size
                                    var scale = img.width / img.naturalWidth;
                                    halo.style.left = ((chest.offsetX * scale)) + 'px';
                                    halo.style.top = ((chest.offsetY * scale)) + 'px';
                                    halo.classList.add('pulse-halo-yellow');
                                    document.body.appendChild(halo);
                                });
                            } else {
                                console.log('No mapJSON chunk found.');
                            }
                        };
                        reader.readAsArrayBuffer(blob);
                    });
            }
            // If the user presses the p key, pick a random portal from the mapData and highlight it on the image with a pulsing halo which lasts for 5 seconds before disappearing
            else if (event.key === 'p') {
                if (mapData && mapData.portals && mapData.portals.length > 0) {
                    const randomIndex = Math.floor(Math.random() * mapData.portals.length);
                    const portal = mapData.portals[randomIndex];
                    const img = document.getElementById('selectedpitch');
                    const halo = document.createElement('div');
                    halo.style.position = 'absolute';
                    halo.style.borderRadius = '50%';
                    halo.style.width = '50px';
                    halo.style.height = '50px';
                    // Get the portal offsetX and offsetY and scale them to the image size compared to the width of the image at its natural size
                    var scale = img.width / img.naturalWidth;
                    halo.style.left = ((portal.offsetX * scale)) + 'px';
                    halo.style.top = ((portal.offsetY * scale)) + 'px';
                    halo.classList.add('pulse-halo');
                    document.body.appendChild(halo);
                    setTimeout(() => {
                        document.body.removeChild(halo);
                    }, 5000);
                } else {
                    console.log('No portal data available.');
                }
            }
        });
        // Initial display
        showImage(currentIndex);
    </script>
</body>
</html>